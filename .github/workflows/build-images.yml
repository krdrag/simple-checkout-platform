name: Build Images

on: workflow_dispatch

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-services:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0.9.7
      with:
        versionSpec: '5.x'
    - name: Determine Version
      uses: gittools/actions/gitversion/execute@v0.9.7
    - name: Docker login
      run: echo ${{ secrets.PACKAGE_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
    - name: Build Identity Image 
      run: docker build -f src/Identity/SCP.Identity.API/Dockerfile . -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/scp-identity:${GITVERSION_NUGETVERSIONV2}
    - name: Push Identity Image
      run: docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/scp-identity:${GITVERSION_NUGETVERSIONV2}
    - name: Build Session Image 
      run: docker build -f src/Identity/SCP.Identity.API/Dockerfile . -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/scp-identity:${GITVERSION_NUGETVERSIONV2}
    - name: Push Session Image
      run: docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/scp-identity:${GITVERSION_NUGETVERSIONV2}